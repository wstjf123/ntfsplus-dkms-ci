From 5a93c1ecb0a79f002977e7192fba2d51e509b9b2 Mon Sep 17 00:00:00 2001
From: shadichy <shadichy@blisslabs.org>
Date: Mon, 3 Nov 2025 17:49:51 +0700
Subject: [PATCH 3/8] ntfsplus: Backport iomap.c functions to kernels older
 than 6.17

---
 fs/ntfs/iomap.c | 26 ++++++++++++++++++++++++++
 fs/ntfs/iomap.h |  4 ++++
 2 files changed, 30 insertions(+)

diff --git a/fs/ntfs/iomap.c b/fs/ntfs/iomap.c
index a4e13a150253..01e8252b70f1 100644
--- a/fs/ntfs/iomap.c
+++ b/fs/ntfs/iomap.c
@@ -732,6 +732,7 @@ const struct iomap_ops ntfs_dio_iomap_ops = {
 	.iomap_end		= ntfs_write_iomap_end,
 };
 
+#if (LINUX_VERSION_CODE >= KERNEL_VERSION(6, 17, 0))
 static ssize_t ntfs_writeback_range(struct iomap_writepage_ctx *wpc,
 		struct folio *folio, u64 offset, unsigned int len, u64 end_pos)
 {
@@ -753,3 +754,28 @@ const struct iomap_writeback_ops ntfs_writeback_ops = {
 	.writeback_range	= ntfs_writeback_range,
 	.writeback_submit	= iomap_ioend_writeback_submit,
 };
+#else
+
+
+
+/*
+ * Compatibility implementation for kernels < 6.17
+ */
+
+static int ntfs_map_blocks(struct iomap_writepage_ctx *wpc, struct inode *inode,
+		loff_t offset, unsigned int len)
+{
+	if (offset >= wpc->iomap.offset &&
+	    offset < wpc->iomap.offset + wpc->iomap.length)
+		return 0;
+
+	return __ntfs_write_iomap_begin(inode, offset,
+			NTFS_I(inode)->allocated_size - offset,
+			IOMAP_WRITE, &wpc->iomap, true, false);
+}
+
+
+const struct iomap_writeback_ops ntfs_writeback_ops = {
+	.map_blocks		= ntfs_map_blocks,
+};
+#endif
\ No newline at end of file
diff --git a/fs/ntfs/iomap.h b/fs/ntfs/iomap.h
index c2602f3ff11a..77181b121f5f 100644
--- a/fs/ntfs/iomap.h
+++ b/fs/ntfs/iomap.h
@@ -12,6 +12,10 @@
 #include "volume.h"
 #include "inode.h"
 
+#if (LINUX_VERSION_CODE < KERNEL_VERSION(6, 17, 0))
+#define iomap_write_ops iomap_folio_ops
+#endif
+
 extern const struct iomap_ops ntfs_write_iomap_ops;
 extern const struct iomap_ops ntfs_read_iomap_ops;
 extern const struct iomap_ops ntfs_page_mkwrite_iomap_ops;
-- 
2.52.0

