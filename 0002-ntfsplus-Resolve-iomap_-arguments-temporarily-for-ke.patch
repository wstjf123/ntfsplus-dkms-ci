From b5e637d1184078866edf7a467294d4ca69bdd0e9 Mon Sep 17 00:00:00 2001
From: shadichy <shadichy@blisslabs.org>
Date: Mon, 29 Dec 2025 21:47:47 +0700
Subject: [PATCH 2/8] ntfsplus: Resolve iomap_* arguments (temporarily) for
 kernel older than 6.17

Signed-off-by: shadichy <shadichy@blisslabs.org>
---
 fs/ntfs/aops.c  |  9 +++++++++
 fs/ntfs/file.c  | 14 +++++++-------
 fs/ntfs/inode.c |  2 +-
 fs/ntfs/inode.h | 13 +++++++++++++
 fs/ntfs/iomap.c |  2 +-
 5 files changed, 31 insertions(+), 9 deletions(-)

diff --git a/fs/ntfs/aops.c b/fs/ntfs/aops.c
index e6670e5bb03e..2390b08c0e29 100644
--- a/fs/ntfs/aops.c
+++ b/fs/ntfs/aops.c
@@ -416,9 +416,13 @@ static int ntfs_writepages(struct address_space *mapping,
 {
 	struct inode *inode = mapping->host;
 	struct ntfs_inode *ni = NTFS_I(inode);
+
+	// Use the new iomap interface from 6.17
 	struct iomap_writepage_ctx wpc = {
+#if (LINUX_VERSION_CODE >= KERNEL_VERSION(6, 17, 0))
 		.inode		= mapping->host,
 		.wbc		= wbc,
+#endif
 		.ops		= &ntfs_writeback_ops,
 	};
 
@@ -443,7 +447,12 @@ static int ntfs_writepages(struct address_space *mapping,
 		return -EACCES;
 	}
 
+	// Use the new iomap writepages from 6.17
+#if (LINUX_VERSION_CODE >= KERNEL_VERSION(6, 17, 0))
 	return iomap_writepages(&wpc);
+#else
+	return iomap_writepages(mapping, wbc, &wpc, &ntfs_writeback_ops);
+#endif
 }
 
 static int ntfs_swap_activate(struct swap_info_struct *sis,
diff --git a/fs/ntfs/file.c b/fs/ntfs/file.c
index 245489f6558d..ec392f314518 100644
--- a/fs/ntfs/file.c
+++ b/fs/ntfs/file.c
@@ -290,7 +290,7 @@ int ntfsp_setattr(struct mnt_idmap *idmap, struct dentry *dentry,
 			/* Serialize against page faults */
 			if (NInoNonResident(NTFS_I(vi)) &&
 			    attr->ia_size < old_size) {
-				err = iomap_truncate_page(vi, attr->ia_size, NULL,
+				err = __iomap_truncate_page(vi, attr->ia_size, NULL,
 							  &ntfs_read_iomap_ops,
 							  &ntfs_iomap_folio_ops, NULL);
 				if (err)
@@ -309,7 +309,7 @@ int ntfsp_setattr(struct mnt_idmap *idmap, struct dentry *dentry,
 				loff_t len = min_t(loff_t,
 							round_up(old_size, PAGE_SIZE) - old_size,
 							attr->ia_size - old_size);
-				err = iomap_zero_range(vi, old_size, len,
+				err = __iomap_zero_range(vi, old_size, len,
 						       NULL, &ntfs_read_iomap_ops,
 						       &ntfs_iomap_folio_ops, NULL);
 			}
@@ -627,7 +627,7 @@ static ssize_t ntfs_file_write_iter(struct kiocb *iocb, struct iov_iter *from)
 
 			offset = iocb->ki_pos;
 			iocb->ki_flags &= ~IOCB_DIRECT;
-			written = iomap_file_buffered_write(iocb, from,
+			written = __iomap_file_buffered_write(iocb, from,
 					&ntfs_write_iomap_ops, &ntfs_iomap_folio_ops,
 					NULL);
 			if (written < 0) {
@@ -647,7 +647,7 @@ static ssize_t ntfs_file_write_iter(struct kiocb *iocb, struct iov_iter *from)
 							 end >> PAGE_SHIFT);
 		}
 	} else {
-		ret = iomap_file_buffered_write(iocb, from, &ntfs_write_iomap_ops,
+		ret = __iomap_file_buffered_write(iocb, from, &ntfs_write_iomap_ops,
 				&ntfs_iomap_folio_ops, NULL);
 	}
 out:
@@ -1021,7 +1021,7 @@ static long ntfs_fallocate(struct file *file, int mode, loff_t offset, loff_t le
 
 			to = min_t(loff_t, NTFS_CLU_TO_B(vol, start_vcn + 1),
 				   end_offset);
-			err = iomap_zero_range(vi, offset, to - offset, NULL,
+			err = __iomap_zero_range(vi, offset, to - offset, NULL,
 					       &ntfs_read_iomap_ops,
 					       &ntfs_iomap_folio_ops, NULL);
 			if (err < 0 || (end_vcn - start_vcn) == 1)
@@ -1032,7 +1032,7 @@ static long ntfs_fallocate(struct file *file, int mode, loff_t offset, loff_t le
 			loff_t from;
 
 			from = NTFS_CLU_TO_B(vol, end_vcn - 1);
-			err = iomap_zero_range(vi, from, end_offset - from, NULL,
+			err = __iomap_zero_range(vi, from, end_offset - from, NULL,
 					       &ntfs_read_iomap_ops,
 					       &ntfs_iomap_folio_ops, NULL);
 			if (err < 0 || (end_vcn - start_vcn) == 1)
@@ -1084,7 +1084,7 @@ static long ntfs_fallocate(struct file *file, int mode, loff_t offset, loff_t le
 			loff_t len = min_t(loff_t,
 					   round_up(old_size, PAGE_SIZE) - old_size,
 					   offset - old_size);
-			err = iomap_zero_range(vi, old_size, len, NULL,
+			err = __iomap_zero_range(vi, old_size, len, NULL,
 					       &ntfs_read_iomap_ops,
 					       &ntfs_iomap_folio_ops, NULL);
 		}
diff --git a/fs/ntfs/inode.c b/fs/ntfs/inode.c
index 97e0857b2389..d79c0e085a41 100644
--- a/fs/ntfs/inode.c
+++ b/fs/ntfs/inode.c
@@ -2423,7 +2423,7 @@ int ntfs_extend_initialized_size(struct inode *vi, const loff_t offset,
 		return err;
 
 	if (!NInoCompressed(ni) && old_init_size < offset) {
-		err = iomap_zero_range(vi, old_init_size,
+		err = __iomap_zero_range(vi, old_init_size,
 				       offset - old_init_size,
 				       NULL, &ntfs_read_iomap_ops,
 				       &ntfs_iomap_folio_ops, NULL);
diff --git a/fs/ntfs/inode.h b/fs/ntfs/inode.h
index a22798e1d756..167f2920b625 100644
--- a/fs/ntfs/inode.h
+++ b/fs/ntfs/inode.h
@@ -351,4 +351,17 @@ int ntfs_extend_initialized_size(struct inode *vi, const loff_t offset,
 		const loff_t new_size);
 void ntfs_set_vfs_operations(struct inode *inode, mode_t mode, dev_t dev);
 
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(6, 17, 0)
+#define __iomap_file_buffered_write iomap_file_buffered_write
+#define __iomap_truncate_page iomap_truncate_page
+#define __iomap_zero_range iomap_zero_range
+#else
+#define __iomap_file_buffered_write(iocb, from, ops, __write_ops, private) \
+	iomap_file_buffered_write(iocb, from, ops, private)
+#define __iomap_truncate_page(inode, pos, did_zero, ops, __write_ops, private) \
+	iomap_truncate_page(inode, pos, did_zero, ops, private)
+#define __iomap_zero_range(inode, pos, len, did_zero, ops, __write_ops, private) \
+	iomap_zero_range(inode, pos, len, did_zero, ops, private)
+#endif
+
 #endif /* _LINUX_NTFS_INODE_H */
diff --git a/fs/ntfs/iomap.c b/fs/ntfs/iomap.c
index e8a765a5d3a4..a4e13a150253 100644
--- a/fs/ntfs/iomap.c
+++ b/fs/ntfs/iomap.c
@@ -306,7 +306,7 @@ int ntfs_zero_range(struct inode *inode, loff_t offset, loff_t length, bool bdir
 					     BLKDEV_ZERO_NOUNMAP);
 	}
 
-	return iomap_zero_range(inode,
+	return __iomap_zero_range(inode,
 				offset, length,
 				NULL,
 				&ntfs_zero_read_iomap_ops,
-- 
2.52.0

