name: build-module

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        kernel: ["6.12"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            bc bison build-essential flex kmod libelf-dev libssl-dev \
            python3 wget xz-utils

      - name: Download Linux kernel source
        run: |
          set -euo pipefail
          KVER='${{ matrix.kernel }}'
          OUT="linux-${KVER}.tar.xz"
          URLS=(
            "https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${KVER}.tar.xz"
            "https://mirrors.edge.kernel.org/pub/linux/kernel/v6.x/linux-${KVER}.tar.xz"
          )
          rm -f "${OUT}"
          for url in "${URLS[@]}"; do
            echo "Downloading ${url}"
            if curl -fL --retry 5 --retry-all-errors --connect-timeout 20 --max-time 900 -o "${OUT}" "${url}"; then
              break
            fi
          done
          test -s "${OUT}"

      - name: Prepare kernel tree (modules_prepare)
        run: |
          set -euo pipefail
          KVER='${{ matrix.kernel }}'
          tar -xf "linux-${KVER}.tar.xz"
          cd "linux-${KVER}"
          make -j"$(nproc)" defconfig
          make -j"$(nproc)" modules_prepare

      - name: Build ntfs module
        run: |
          set -euo pipefail
          KVER='${{ matrix.kernel }}'
          make -C "$GITHUB_WORKSPACE/out-of-tree" \
            KERNEL_SRC="$GITHUB_WORKSPACE/linux-${KVER}" \
            KVERSION="${KVER}" \
            CONFIG_NTFS_FS=m \
            CONFIG_NTFS_FS_POSIX_ACL=y \
            CFLAGS_MODULE='-include linux/version.h'
          test -f "$GITHUB_WORKSPACE/out-of-tree/ntfs.ko"
