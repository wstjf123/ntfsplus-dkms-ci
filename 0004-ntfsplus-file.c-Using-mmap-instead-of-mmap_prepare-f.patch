From dfb666894f678cc5dc4bb9e2538da86cb41d2a20 Mon Sep 17 00:00:00 2001
From: shadichy <shadichy@blisslabs.org>
Date: Thu, 6 Nov 2025 20:26:04 +0700
Subject: [PATCH 4/8] ntfsplus: file.c: Using `mmap` instead of `mmap_prepare`
 for kernels older than 6.15

---
 fs/ntfs/file.c | 30 ++++++++++++++++++++++++------
 1 file changed, 24 insertions(+), 6 deletions(-)

diff --git a/fs/ntfs/file.c b/fs/ntfs/file.c
index ec392f314518..34d4e54d9b69 100644
--- a/fs/ntfs/file.c
+++ b/fs/ntfs/file.c
@@ -692,9 +692,10 @@ static const struct vm_operations_struct ntfs_file_vm_ops = {
 	.page_mkwrite	= ntfs_filemap_page_mkwrite,
 };
 
-static int ntfs_file_mmap_prepare(struct vm_area_desc *desc)
+static int __ntfs_file_mmap_compat(struct file *file, unsigned long vm_flags,
+	unsigned long pgoff, unsigned long start, unsigned long end,
+	const struct vm_operations_struct **vm_ops)
 {
-	struct file *file = desc->file;
 	struct inode *inode = file_inode(file);
 
 	if (NVolShutdown(NTFS_SB(file->f_mapping->host->i_sb)))
@@ -703,14 +704,14 @@ static int ntfs_file_mmap_prepare(struct vm_area_desc *desc)
 	if (NInoCompressed(NTFS_I(inode)))
 		return -EOPNOTSUPP;
 
-	if (desc->vm_flags & VM_WRITE) {
+	if (vm_flags & VM_WRITE) {
 		struct inode *inode = file_inode(file);
 		loff_t from, to;
 		int err;
 
-		from = ((loff_t)desc->pgoff << PAGE_SHIFT);
+		from = ((loff_t)pgoff << PAGE_SHIFT);
 		to = min_t(loff_t, i_size_read(inode),
-			   from + desc->end - desc->start);
+			   from + end - start);
 
 		if (NTFS_I(inode)->initialized_size < to) {
 			err = ntfs_extend_initialized_size(inode, to, to);
@@ -721,10 +722,23 @@ static int ntfs_file_mmap_prepare(struct vm_area_desc *desc)
 
 
 	file_accessed(file);
-	desc->vm_ops = &ntfs_file_vm_ops;
+	*vm_ops = &ntfs_file_vm_ops;
 	return 0;
 }
 
+#if (LINUX_VERSION_CODE >= KERNEL_VERSION(6, 16, 0))
+static int ntfs_file_mmap_prepare(struct vm_area_desc *desc)
+{
+	return __ntfs_file_mmap_compat(desc->file, desc->vm_flags, desc->pgoff,
+		desc->start, desc->end, &desc->vm_ops);
+}
+#else
+static int ntfs_file_mmap(struct file *file, struct vm_area_struct *vma) {
+	return __ntfs_file_mmap_compat(file, vma->vm_flags, vma->vm_pgoff,
+		vma->vm_start, vma->vm_end, &vma->vm_ops);
+}
+#endif
+
 static int ntfs_fiemap(struct inode *inode, struct fiemap_extent_info *fieinfo,
 		u64 start, u64 len)
 {
@@ -1102,7 +1116,11 @@ const struct file_operations ntfs_file_ops = {
 	.read_iter	= ntfs_file_read_iter,
 	.write_iter	= ntfs_file_write_iter,
 	.fsync		= ntfs_file_fsync,
+#if (LINUX_VERSION_CODE >= KERNEL_VERSION(6, 16, 0))
 	.mmap_prepare	= ntfs_file_mmap_prepare,
+#else
+	.mmap		= ntfs_file_mmap,
+#endif
 	.open		= ntfs_file_open,
 	.release	= ntfs_file_release,
 	.splice_read	= ntfs_file_splice_read,
-- 
2.52.0

