From 0b84b5bb905d7b900492902e186c3382a3001585 Mon Sep 17 00:00:00 2001
From: shadichy <shadichy@blisslabs.org>
Date: Thu, 6 Nov 2025 16:56:54 +0700
Subject: [PATCH 6/8] ntfsplus: Update `iomap_zero_range`, `iomap_page_mkwrite`
 and `iomap_truncate_page` for kernels older than 6.15

---
 fs/ntfs/file.c  |  2 +-
 fs/ntfs/inode.h | 16 +++++++++++++++-
 2 files changed, 16 insertions(+), 2 deletions(-)

diff --git a/fs/ntfs/file.c b/fs/ntfs/file.c
index 34d4e54d9b69..9e530a3658f4 100644
--- a/fs/ntfs/file.c
+++ b/fs/ntfs/file.c
@@ -681,7 +681,7 @@ static vm_fault_t ntfs_filemap_page_mkwrite(struct vm_fault *vmf)
 	sb_start_pagefault(inode->i_sb);
 	file_update_time(vmf->vma->vm_file);
 
-	ret = iomap_page_mkwrite(vmf, &ntfs_page_mkwrite_iomap_ops, NULL);
+	ret = __iomap_page_mkwrite(vmf, &ntfs_page_mkwrite_iomap_ops, NULL);
 	sb_end_pagefault(inode->i_sb);
 	return ret;
 }
diff --git a/fs/ntfs/inode.h b/fs/ntfs/inode.h
index 167f2920b625..888b9d6b2c57 100644
--- a/fs/ntfs/inode.h
+++ b/fs/ntfs/inode.h
@@ -351,17 +351,31 @@ int ntfs_extend_initialized_size(struct inode *vi, const loff_t offset,
 		const loff_t new_size);
 void ntfs_set_vfs_operations(struct inode *inode, mode_t mode, dev_t dev);
 
+/*
+ * Wrappers for backward compatibility
+ */
 #if LINUX_VERSION_CODE >= KERNEL_VERSION(6, 17, 0)
 #define __iomap_file_buffered_write iomap_file_buffered_write
 #define __iomap_truncate_page iomap_truncate_page
 #define __iomap_zero_range iomap_zero_range
-#else
+#define __iomap_page_mkwrite iomap_page_mkwrite
+#elif LINUX_VERSION_CODE >= KERNEL_VERSION(6, 15, 0)
 #define __iomap_file_buffered_write(iocb, from, ops, __write_ops, private) \
 	iomap_file_buffered_write(iocb, from, ops, private)
 #define __iomap_truncate_page(inode, pos, did_zero, ops, __write_ops, private) \
 	iomap_truncate_page(inode, pos, did_zero, ops, private)
 #define __iomap_zero_range(inode, pos, len, did_zero, ops, __write_ops, private) \
 	iomap_zero_range(inode, pos, len, did_zero, ops, private)
+#define __iomap_page_mkwrite iomap_page_mkwrite
+#else
+#define __iomap_file_buffered_write(iocb, from, ops, __write_ops, private) \
+	iomap_file_buffered_write(iocb, from, ops, private)
+#define __iomap_truncate_page(inode, pos, did_zero, ops, __write_ops, __private) \
+	iomap_truncate_page(inode, pos, did_zero, ops)
+#define __iomap_zero_range(inode, pos, len, did_zero, ops, __write_ops, __private) \
+	iomap_zero_range(inode, pos, len, did_zero, ops)
+#define __iomap_page_mkwrite(vmf, ops, __private) \
+	iomap_page_mkwrite(vmf, ops)
 #endif
 
 #endif /* _LINUX_NTFS_INODE_H */
-- 
2.52.0

